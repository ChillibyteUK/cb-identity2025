<?php
/**
 * CB Content Grid Block Template
 *
 * @package  cb-identity2025
 */

// Exit if accessed directly.
if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

// Use block context for ACF field access.
if ( ! have_rows( 'grid_rows', $block['id'] ?? null ) ) {
    return;
}
?>
<section class="cb-content-grid container">
    <?php
    while ( have_rows( 'grid_rows', $block['id'] ?? null ) ) {
        the_row();
    $layout = get_sub_field('acf_fc_layout');

        // --- Single module row ---
    if ( 'single_module_row' === $layout ) {
        $mtype      = get_sub_field( 'module_type' );
        $width_raw  = get_sub_field( 'column_width' );
        $offset_raw = get_sub_field( 'column_offset' );
        $width      = intval( $width_raw );
        $offset     = intval( $offset_raw );
        if ( $width < 1 || $width > 12 ) {
            $width = 12;
        }
        if ( $offset < 0 ) {
            $offset = 0;
        }
        if ( $offset > 11 ) {
            $offset = 11;
        }
        if ( $width + $offset > 12 ) {
            $offset = max( 0, 12 - $width );
        }
    $class = trim( get_sub_field( 'custom_class' ) );

        $col_classes = array(
            'col-md-' . esc_attr( $width ),
        );
        if ( $offset && '0' !== $offset ) {
            $col_classes[] = 'offset-md-' . esc_attr( $offset );
        }
        if ( $class ) {
            $col_classes[] = sanitize_html_class( $class );
        }
        ?>
        <div class="row gx-4 gy-5">
            <div class="<?= esc_attr( implode( ' ', $col_classes ) ); ?>">
                <?php
                if ( 'image' === $mtype || 'Image' === $mtype ) {
                    $image_id = get_sub_field( 'image' );
                    $caption  = get_sub_field( 'caption' );
                    if ( $image_id ) {
                        echo wp_get_attachment_image( $image_id, 'large', false, array( 'class' => 'img-fluid' ) );
                    }
                    if ( $caption ) {
                        echo '<p class="image-caption small text-muted mt-2">' . esc_html( $caption ) . '</p>';
                    }
                } elseif ( 'text' === $mtype || 'Text' === $mtype ) {
                    the_sub_field( 'text' );
                } elseif ( 'video' === $mtype || 'Video' === $mtype ) {
                    $vimeo_url = get_sub_field( 'vimeo_url' );
                    if ( $vimeo_url ) {
                        echo '<div class="ratio ratio-16x9">';
                        echo wp_kses_post( wp_oembed_get( esc_url( $vimeo_url ) ) );
                        echo '</div>';
                    }
                }
                ?>
            </div>
        </div>
    <?php }
    // --- Multi-module row ---
    elseif ( 'multi_module_row' === $layout && have_rows( 'modules' ) ) {
        ?>
        <div class="row gx-4 gy-5">
            <?php
            while ( have_rows( 'modules' ) ) {
                the_row();
                $mtype      = get_sub_field( 'module_type' );
                $width_raw  = get_sub_field( 'column_width' );
                $offset_raw = get_sub_field( 'column_offset' );
                $width      = intval( $width_raw );
                $offset     = intval( $offset_raw );
                if ( $width < 1 || $width > 12 ) {
                    $width = 12;
                }
                if ( $offset < 0 ) {
                    $offset = 0;
                }
                if ( $offset > 11 ) {
                    $offset = 11;
                }
                if ( $width + $offset > 12 ) {
                    $offset = max( 0, 12 - $width );
                }
                $class = trim( get_sub_field( 'custom_class' ) );

                $col_classes = array(
                    'col-md-' . esc_attr( $width ),
                );
                if ( $offset && '0' !== $offset ) {
                    $col_classes[] = 'offset-md-' . esc_attr( $offset );
                }
                if ( $class ) {
                    $col_classes[] = sanitize_html_class( $class );
                }
                ?>
                <div class="<?= esc_attr( implode( ' ', $col_classes ) ); ?>">
                    <?php
                    if ( 'image' === $mtype || 'Image' === $mtype ) {
                        $image_id = get_sub_field( 'image' );
                        $caption  = get_sub_field( 'caption' );
                        if ( $image_id ) {
                            echo wp_get_attachment_image( $image_id, 'large', false, array( 'class' => 'img-fluid' ) );
                        }
                        if ( $caption ) {
                            echo '<p class="image-caption small text-muted mt-2">' . esc_html( $caption ) . '</p>';
                        }
                    } elseif ( 'text' === $mtype || 'Text' === $mtype ) {
                        the_sub_field( 'text' );
                    } elseif ( 'video' === $mtype || 'Video' === $mtype ) {
                        $vimeo_url = get_sub_field( 'vimeo_url' );
                        if ( $vimeo_url ) {
                            echo '<div class="ratio ratio-16x9">';
                            echo wp_kses_post( wp_oembed_get( esc_url( $vimeo_url ) ) );
                            echo '</div>';
                        }
                    }
                    ?>
                </div>
            ?>
            <?php
            ?>
        </div>
    <?php }
    }

    <?php }

    }

    ?>

</section>
